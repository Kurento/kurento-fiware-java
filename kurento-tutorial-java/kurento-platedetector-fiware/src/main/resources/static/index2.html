<html lang="en">

<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content=""/>
    <meta name="author" content=""/>

   	<title>User Registry</title>

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"/> 

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

	<!--  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css"/> -->
	
	<!-- Theme CSS -->
    <link href="css/freelancer.css" rel="stylesheet"/>
    
 	<link href="css/kurento.css" rel="stylesheet"/>
 	
 	<!-- <script src="js/registry.js"></script> -->
 	
    <!-- Custom Fonts -->
    <link href="vendor/materialdesignicon/css/material-design-icons.css" rel="stylesheet"/>
	<link href="vendor/socialbuttons/css/bootstrap-social.css" rel="stylesheet"/>
	<link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet"/>
    
    <!-- angular -->
    <script type="text/javascript" src="webjars/angularjs/1.7.0/angular.min.js"></script>
    <script type="text/javascript" src="webjars/angularjs/1.7.0/angular-route.js"></script>
    <script src="https://angular-ui.github.io/bootstrap/ui-bootstrap-tpls-2.5.0.js"></script>
    
    <script type="text/javascript">
    angular.module('ngReallyClickModule', ['ui.bootstrap'])
	  .directive('ngReallyClick', ['$uibModal',
	    function($uibModal) {

	      var ModalInstanceCtrl = function($scope, $uibModalInstance) {
	        $scope.ok = function() {
	        	$uibModalInstance.close();
	        };

	        $scope.cancel = function() {
	        	$uibModalInstance.dismiss('cancel');
	        };
	      };

	      return {
	        restrict: 'A',
	        scope: {
	          ngReallyClick:"&"
	        },
	        link: function(scope, element, attrs) {
	          element.bind('click', function() {
	        	var header = attrs.ngReallyHeader || "Confirmation"
	            var message = attrs.ngReallyMessage || "Are you sure to proceed?";

	        	var modalHtml = '<div class="modal-header">'+header+'</div>';
	            modalHtml += '<div class="modal-body">' + message + '</div>';
	            modalHtml += '<div class="modal-footer"><button class="btn btn-primary" ng-click="ok()">Continue</button><button class="btn btn-default" ng-click="cancel()">Cancel</button></div>';

	            var modalInstance = $uibModal.open({
	              template: modalHtml,
	              controller: ModalInstanceCtrl
	            });

	            modalInstance.result.then(function() {
	              scope.ngReallyClick();
	            }, function() {
	              //Modal dismissed
	            });
	            
	          });

	        }
	      }
	    }
	  ]);		
    angular.module("app", ['ui.bootstrap', 'ngReallyClickModule'])
    .constant("CSRF_TOKEN", '{{ csrf_token() }}')
	.config(
			function($httpProvider) {
				$httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
			})
	.controller(
		"home", 
		['$location', '$scope', '$http', 
		function($location, $scope, $http, CSRF_TOKEN){
			var self = this;
			self.edition = false;
			console.log($location.absUrl().indexOf("error="))
			if ($location && $location.absUrl().indexOf("error=unauthenticated") >= 0) {
				self.authenticated = false;
				self.error = true;
				$('#error').text("You aren't logged in. Please log in and try again");
			}
			if ($location && $location.absUrl().indexOf("error=generic") >= 0) {
				self.error = true;
				$('#error').text("An undefinend error has occured please contact the administrator elastest@naevatec.com");
			}
			$scope.getregistereddata = function() {
				//after login we ask the application for the registered application
				$http.post("registration")
					.then(function (data){											
						if (data.data.userRegistered && data.data.userRegistered.registered){
							self.isRegistered=true;
							self.registered_info= data.data.userRegistered.info;	
							console.log("Already REGISTERED!");
							// $('#registered') show information and check 
						}
						else{
							self.isRegistered=false;
							console.log("NOT registered!");
							// $('#registryForm') autofill some fields 
						}
				}).catch(function() {
					console.log("error");
				});
			}
			$http.post("user")
					.then(function(data) {							
								if (data.data.userAuthentication) {
									self.user = data.data.userAuthentication.details.name;
									self.authenticated = true;
									self.profile_img=data.data.userAuthentication.details.avatar_url;
									self.username = data.data.userAuthentication.details.login;
									self.email = data.data.userAuthentication.details.email;
									
									$scope.getregistereddata();
								} else {
									self.authenticated = false
								}
							}).catch(function() {
						self.user = "N/A";
						self.authenticated = false;
					});
			self.logout = function() {
				$http.post('logout', {}).then(function() {
					self.authenticated = false;
					self.user = null;
					self.user = null;
					self.profile_img=null;
					self.username = null;
					self.email = null;
				}).catch(function() {
		    		console.log("error logout");
		    	})
				.finally(function(){
					console.log("end logout");
				});	     	
			};
			
			self.checkAndSend = function(id) {
 				if(validate(id)){
 					var data = JSON.stringify({ 	
							firstname: $scope.registry.r_form.firstname.$viewValue, 
			     			lastname: $scope.registry.r_form.lastname.$viewValue,
 						email: $scope.registry.r_form.email.$viewValue,
 						partner: $scope.registry.r_form.partner.$viewValue,	     		
 						csrf_token: CSRF_TOKEN
 					});	     					
 					//var formData = new FormData(document.querySelector('#'+id))
 					$http.post('sendregister', data)
     				    .then(function() {
     				    	console.log("success");	    
     				    	 $scope.getregistereddata();
     				    	})
     				    	.catch(function() {
     				    		console.log("error");
     				    	})
     						.finally(function(){
     							console.log("end checkAndSend");
     						});	     	
 				    }		  
 			};
 			
			self.deleteuser = function() {	     		 					
				//var formData = new FormData(document.querySelector('#'+id))
				$http.post('deleteuser')
			    	.then(function() {
				    	console.log("success");
				    	self.registered_info= null;
				    	 $scope.getregistereddata();			    	
			    	})
			    	.catch(function() {
			    		console.log("error");
			    	})
					.finally(function(){
						console.log("end Delete");
					});	     				
			};
				
			self.activatenexus = function() {	     		 					
				//var formData = new FormData(document.querySelector('#'+id))
				$http.post('activatenexus')
			    	.then(function(data) {
			    		console.log("NEXUS ACTIVATE: "+ data.data.result);
			    		self.registered_info= data.data.userRegistered.info;			 
			    	})
			    	.catch(function() {
			    		console.log("error");
			    	})
					.finally(function(){
						console.log("end activate Nexus");
					});	     				
			};
			
			self.activateaws = function() {	     		 					
				//var formData = new FormData(document.querySelector('#'+id))
				$http.post('activateaws')
			    	.then(function(data) {
				    	self.registered_info= data.data.userRegistered.info;
				    	console.log("AWS Activate!");
			    	})
			    	.catch(function() {
			    		console.log("error");
			    	})
					.finally(function(){
						console.log("end Activate AWS");
					});	     				
			};
			self.revokenexus = function() {	     		 					
				//var formData = new FormData(document.querySelector('#'+id))
				$http.post('revokenexus')
			    	.then(function(data) {
				    	self.registered_info= data.data.userRegistered.info;
				    	console.log("NEXUS DELETE: "+ data.data.result);
			    	})
			    	.catch(function() {
			    		console.log("error");
			    	})
					.finally(function(){
						console.log("end revoke NEXUS");
					});	     				
			};
			self.revokeaws = function() {	     		 					
				//var formData = new FormData(document.querySelector('#'+id))
				$http.post('revokeaws')
			    	.then(function(data) {
				    	self.registered_info= data.data.userRegistered.info;
				    	console.log("AWS REVOKED!");
			    	})
			    	.catch(function() {
			    		console.log("error");
			    	})
					.finally(function(){
						console.log("end REVOKE AWS");
					});	     				
			};	
			self.resetnexus = function() {	     		 					
				//var formData = new FormData(document.querySelector('#'+id))
				$http.post('resetnexus')
			    	.then(function(data) {
				    	self.registered_info= data.data.userRegistered.info;
				    	console.log("Nexus RESETED!");
			    	})
			    	.catch(function() {
			    		console.log("error");
			    	})
					.finally(function(){
						console.log("end RESET NEXUS");
					});	     				
			};
			self.resetaws = function() {	     		 					
				//var formData = new FormData(document.querySelector('#'+id))
				$http.post('resetaws')
			    	.then(function(data) {
				    	self.registered_info= data.data.userRegistered.info;
				    	console.log("AWS RESETED!");
			    	})
			    	.catch(function() {
			    		console.log("error");
			    	})
					.finally(function(){
						console.log("end RESET AWS");
					});	     				
			};
			self.activateEdition = function(){
				self.edition = true;
			};
			self.sendEdition = function(id){
				if(validate(id)){
 					var data = JSON.stringify({ 	
							firstname: $scope.edition.e_form.firstname.$viewValue, 
			     			lastname: $scope.edition.e_form.lastname.$viewValue,
 							email: $scope.edition.e_form.email.$viewValue,
 							csrf_token: CSRF_TOKEN
 					});	     					
 					//var formData = new FormData(document.querySelector('#'+id))
 					$http.post('sendedition', data)
     				    .then(function() {
     				    	console.log("success");	    
     				    	 $scope.getregistereddata();
     				    	self.edition = false;
     				    	})
     				    	.catch(function() {
     				    		console.log("error");
     				    	})
     						.finally(function(){
     							console.log("end checkAndSend");
     						});	     	
 				    }		  
			};
			self.cancelEdition=function(){
				self.edition = false;
			}
		}]); 
	    
   	 
    	
	</script>
    
</head>

<body id="page-top" class="index" data-ng-app="app" data-ng-controller="home as home">
<div id="skipnav"><a href="#maincontent">Skip to main content</a></div>

    <!-- Navigation -->
    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top navbar-custom">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="#page-top">Orion + Kurento Tutorial</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
	        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	             <ul class="nav navbar-nav navbar-right">
						<li>
							<a href="https://github.com/Kurento/kurento-fiware-java/tree/master/kurento-tutorial-java/kurento-platedetector-fiware">
								<span class="glyphicon glyphicon-file"></span> Source Code</a>
						</li>
					</ul> 
            </div>  
            <!-- /.navbar-collapse -->
            <div id="error" class="alert alert-danger" data-ng-show="home.error" data-ng-cloak class="ng-cloak"></div>
            
            <div id="alert" class="alert alert-warning" data-ng-show="home.warn" data-ng-cloak class="ng-cloak"></div>

			<div id="alert" class="alert alert-info" data-ng-show="home.info" data-ng-cloak class="ng-cloak"></div>
        </div>
        <!-- /.container-fluid -->
    </nav>

    <!-- Header -->
    <header>   
        <div class="container" id="instructions" tabindex="-1">
            <div class="row">
                <div class="col-lg-12">
                    <div class="intro-text">
                        <h1 class="name">Tutorial: WebRTC Plate Detector Filter with Orion Integration</h1>
                        <p>This application shows a WebRtcEndpoint connected to itself (loopback) with a PlateDetector filter in the middle (take a look to the Media Pipeline) Whenever a plate is detected it is processed and archived in Orion. To run this demo follow these steps:</p>
						<ul>
							<ol>Open this page with a browser compliant with WebRTC (Chrome, Firefox).</ol>
							<ol>Register a new device (webcam) by pressing addDevice</ol>
							<ol>Select a device from the list and start recieving the output of the selected cam and the event registered </ol>
						</ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <section id="maincontainer">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 text-center">
                    <h3>Register Cam</h3>
                    <hr class="star-light"></hr>
                </div>
				 <div class="col-lg-6 text-center">
                    <h3>Registered Devices </h3>
                    <hr class="star-light"></hr>
                </div>
            </div>
            <div class="row main">
				<div class="col-lg-6">
					<h4>Local stream</h4>
					<video id="videoInput" autoplay width="480px" height="360px"
							poster="img/webrtc.png"></video>
				</div>
				<div class=col-lg-6" data-ng-show="!home.mediaselected">
					Here there should be a list with the registered devices
					those with ON state should be clickable rest not
				</div>
				<div class=col-lg-6" data-ng-show="home.mediaselected">
					<h4>Remote stream</h4>
					<video id="videoOutput" autoplay width="480px" height="360px"
						poster="img/webrtc.png"></video>
				</div>
            </div>
			<div class="row buttons">
				<div class="col-md-6" data-ng-show="!home.registered">
					<a id="register" href="#" class="btn btn-default" onclick="home.register()">
							<span class="glyphicon glyphicon-webcam"></span> Register </a>
				</div>
				<div class="col-md-3" data-ng-show="home.registered">
					<a id="start" href="#" class="btn btn-success " onclick="home.start()">
							<span class="glyphicon glyphicon-play"></span> Start </a>
				</div>
				<div class="col-md-3" data-ng-show="home.registered">
					<a id="start" href="#" class="btn btn-danger" onclick="home.stop()">
							<span class="glyphicon glyphicon-stop"></span> Stop </a>
				</div>
			</div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="text-center">
        <div class="footer-above">
            <div class="container">
                <div class="row">
                    <div class="col-md-3">
						<a href="http://www.urjc.es"><img src="img/urjc.gif"
							alt="Universidad Rey Juan Carlos" height="50px" /></a>
					</div>
					<div class="col-md-3">
						<a href="http://www.kurento.org"><img src="img/kurento.png"
							alt="Kurento" height="50px" /></a>
					</div>
					<div class="col-md-3">
						<a href="https://www.fiware.org"><img src="img/fiware.png"
							alt="Fiware" height="50px" /></a>
					</div>
					<div class="col-md-3">
						<a href="http://www.naevatec.com"><img src="img/naevatec.png"
							alt="Naevatec" height="50px" /></a>
					</div>
                </div>
            </div>
        </div>
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        Copyright &copy; <a href="http://www.kurento.org"> Kurento </a>	2017
                    </div>
                </div>
            </div>
        </div>
    </footer>

	
    <!-- jQuery -->
    <script src="vendor/jquery/jquery.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Theme JavaScript -->
    <script src="js/freelancer.min.js"></script>

</body>

</html>
